# -*- coding: utf-8 -*-
import sys
from typing import List

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏ Windows
if sys.stdout.encoding != 'utf-8':
    sys.stdout.reconfigure(encoding='utf-8')

from models.product import Product
from config import Config


class PromptService:
    def __init__(self):
        self.search_model = Config.SEARCH_MODEL
        self.consult_model = Config.CONSULT_MODEL

    def create_search_prompt(self, question: str, products: List[Product],
                             salon_name: str, total_products: int) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤"""
        products_text = self._format_products_for_prompt(products)

        prompt = f"""
        –¢—ã –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –≤ –æ—Ä—Ç–æ–ø–µ–¥–∏—á–µ—Å–∫–æ–º —Å–∞–ª–æ–Ω–µ "{salon_name}".

        –í–û–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: {question}

        –ù–ê–ô–î–ï–ù–ù–´–ï –¢–û–í–ê–†–´:
        {products_text}

        –ò–ù–°–¢–†–£–ö–¶–ò–Ø:
        1. –ü–µ—Ä–µ—á–∏—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã —Å —Ü–µ–Ω–∞–º–∏ –∏ —Å—Å—ã–ª–∫–∞–º–∏
        2. –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ –º–Ω–æ–≥–æ - —Å–∫–∞–∂–∏ "–ø–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ {len(products)} —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ {total_products}, –Ω–∞–ø–∏—à–∏—Ç–µ '–µ—â–µ' –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è"
        3. –ù–ï –ø–∏—à–∏ "–∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é", "–æ–¥–Ω–∞–∫–æ" –∏ —Ç.–¥.
        4. –ë—É–¥—å —Ç–æ—á–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º
        5. –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–π —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä—ã

        –û–¢–í–ï–¢:
        """

        print(f"üìù –î–ª–∏–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞ –ø–æ–∏—Å–∫–∞: {len(prompt)} —Å–∏–º–≤–æ–ª–æ–≤")
        return prompt

    def create_more_products_prompt(self, products: List[Product], salon_name: str) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–∫–∞–∑–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤"""
        products_text = self._format_products_for_prompt(products)

        prompt = f"""
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª "–µ—â–µ" —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Å–∞–ª–æ–Ω–µ {salon_name}.

        –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –¢–û–í–ê–†–´:
        {products_text}

        –ö—Ä–∞—Ç–∫–æ –ø–µ—Ä–µ—á–∏—Å–ª–∏ —ç—Ç–∏ —Ç–æ–≤–∞—Ä—ã —Å —Ü–µ–Ω–∞–º–∏ –∏ —Å—Å—ã–ª–∫–∞–º–∏.
        –í –∫–æ–Ω—Ü–µ –ø—Ä–µ–¥–ª–æ–∂–∏ –Ω–∞–ø–∏—Å–∞—Ç—å "–µ—â–µ" –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.

        –û–¢–í–ï–¢:
        """

        return prompt

    def create_consultation_prompt(self, question: str, stelki_text: str) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ —Å—Ç–µ–ª—å–∫–∞–º"""
        system_role = """–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –æ—Ä—Ç–æ–ø–µ–¥–∏—á–µ—Å–∫–∏–º —Å—Ç–µ–ª—å–∫–∞–º ORTOS. 
    –ë—É–¥—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –≤ –æ–±—â–µ–Ω–∏–∏, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã. –û—Ç–≤–µ—á–∞–π –ø–æ —Å—É—Ç–∏ –≤–æ–ø—Ä–æ—Å–∞.

    –í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
    ‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: —É–ª. –ì–∏–∫–∞–ª–æ, 1, –ú–∏–Ω—Å–∫
    ‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω—ã: +375 (29) 145-03-03, +375 (17) 355-77-03  
    ‚Ä¢ –°–∞–π—Ç: ortos.by
    ‚Ä¢ –í—ã–µ–∑–¥–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º

    –í–ê–ñ–ù–û: 
    - –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
    - –†–∞–∑–ª–∏—á–∞–π –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —Å–∞–ª–æ–Ω—ã –∏ –≤—ã–µ–∑–¥–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏:
      * –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —Å–∞–ª–æ–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –∞–¥—Ä–µ—Å—É
      * –í—ã–µ–∑–¥–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ - —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç—ã –≤ –≥–æ—Ä–æ–¥–∞
    
    –£–ø–æ–º–∏–Ω–∞–π –∞–¥—Ä–µ—Å —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –∑–∞–ø–∏—Å—å –∏–ª–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é!"""

        prompt = f"""–í–û–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê: {question}

    –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –°–¢–ï–õ–¨–ö–ê–• ORTOS:
    {stelki_text}

    –î–∞–≤–∞–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π –æ—Ç–≤–µ—Ç:"""

        return prompt, system_role

    def _format_products_for_prompt(self, products: List[Product]) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–æ–≤–∞—Ä—ã –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞"""
        if not products:
            return "–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

        products_text = ""
        for product in products:
            size = product.get_size()
            products_text += f"{product.name} | {product.price}—Ä | {size} | {product.url}\n"

        return products_text

    def get_model_for_task(self, task_type: str) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â—É—é –º–æ–¥–µ–ª—å –¥–ª—è –∑–∞–¥–∞—á–∏"""
        if task_type == "search":
            return self.search_model
        elif task_type == "consultation":
            return self.consult_model
        else:
            return self.search_model
